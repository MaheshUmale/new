<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Strategy Trading Alerts Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #ffffff;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff9900, #ff6b35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            font-size: 1rem;
            color: #cccccc;
        }

        /* Controls and Status */
        .controls-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        #scan-status {
            font-weight: bold;
            color: #ff9900;
        }

        .loading-indicator {
            display: none;
            color: #ffcc00;
            font-weight: 500;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        /* Table Styling */
        .data-section h2 {
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: #ff9900;
            border-bottom: 1px solid rgba(255, 153, 0, 0.3);
            padding-bottom: 8px;
        }

        .table-container {
            overflow-x: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; 
        }

        thead th {
            background-color: rgba(255, 255, 255, 0.1);
            color: #ff9900;
            padding: 12px 15px;
            text-align: left;
            border-bottom: 2px solid #ff9900;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.05);
        }

        tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.15);
            transition: background-color 0.2s;
        }

        tbody td {
            padding: 10px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            white-space: nowrap;
        }

        .no-data {
            text-align: center;
            padding: 20px !important;
            font-style: italic;
            color: #ccc;
        }
        
        .alert-row .trigger-type {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Real-Time Trading Triggers</h1>
            <p>Live alerts fired from established high-probability and high-potential setups.</p>
        </div>

        <!-- Controls and Status -->
        <div class="controls-status">
            <span id="scan-status">Initializing real-time feed...</span>
            <span id="lastUpdated" class="loading-indicator">Updating...</span>
        </div>

        <!-- Main Data Display -->
        <div class="data-section">
            <h2>Fired Alerts</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Time Fired</th>
                            <th>Symbol</th>
                            <th>Trigger Type</th>
                            <th>Setup TF</th>
                            <th>Price</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="alertsBody">
                        <!-- Data rows will be inserted here by JavaScript -->
                        <tr><td colspan="6" class="no-data">Loading alert data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        class MultiStrategyDashboard {
            constructor() {
                // DOM Elements
                this.alertsBody = document.getElementById('alertsBody');
                this.statusElement = document.getElementById('scan-status');
                this.loadingIndicator = document.getElementById('lastUpdated');
                
                // Initial Load
                this.fetchData();
                this.startAutoRefresh();
            }

            /**
             * Fetches the latest fired alerts from the Flask backend.
             * Uses JSON sanitization to handle potential 'NaN' issues from Pandas.
             * @param {boolean} showLoader - Whether to show the loading indicator.
             */
            async fetchData(showLoader = true) {
                if (showLoader) {
                    this.showLoading();
                }
                
                try {
                    this.statusElement.textContent = 'Fetching latest alerts...';
                    
                    // IMPORTANT: Using /alerts endpoint for real-time triggers
                    const response = await fetch('/alerts'); 
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    // 1. Get raw text to handle NaN issues
                    const rawText = await response.text();
                    
                    // 2. Sanitize: Replace JSON-invalid 'NaN' with 'null'
                    const cleanText = rawText.replace(/:\s*NaN/g, ':null');
                    
                    // 3. Parse the cleaned JSON
                    const data = JSON.parse(cleanText);
                    
                    this.renderData(data);
                } catch (error) {
                    console.error('Error fetching alert results:', error);
                    this.statusElement.textContent = 'Error fetching data. Check console for details.';
                    this.alertsBody.innerHTML = '<tr><td colspan="6" class="no-data">Failed to load data from server. Check console for errors.</td></tr>';
                } finally {
                    this.hideLoading();
                }
            }

            /**
             * Renders the fetched alert data into the HTML table.
             * @param {Array<Object>} data - Array of alert result objects.
             */
            renderData(data) {
                this.alertsBody.innerHTML = ''; // Clear existing rows

                if (!data || data.length === 0) {
                    this.alertsBody.innerHTML = '<tr><td colspan="6" class="no-data">No active alerts have been fired yet.</td></tr>';
                    this.statusElement.textContent = 'Alerts feed active: 0 new alerts.';
                    return;
                }

                // Sort by triggered_at descending (most recent first)
                data.sort((a, b) => new Date(b.triggered_at) - new Date(a.triggered_at));

                data.forEach(alert => {
                    let triggeredTime = 'N/A';
                    if (alert.triggered_at) {
                        try {
                            // Date is likely an ISO string from the backend
                            triggeredTime = new Date(alert.triggered_at).toLocaleTimeString();
                        } catch (e) {
                            triggeredTime = 'Invalid Time';
                        }
                    }
                    
                    const currentPrice = alert.current_price ? `$${alert.current_price.toFixed(2)}` : 'N/A';
                    const triggerType = alert.trigger_type || 'Unknown';
                    const setupTf = alert.setup_tf || 'N/A';

                    // Determine color based on Trigger Type
                    let typeColor = '#fff';
                    if (triggerType.includes('Upper Band') || triggerType.includes('Bounce')) {
                        typeColor = '#00ff88'; // Buy/Long
                    } else if (triggerType.includes('Lower Band')) {
                        typeColor = '#ff6b35'; // Sell/Short
                    }

                    const row = this.alertsBody.insertRow();
                    row.classList.add('alert-row');
					const urlSymbol = alert.symbol.replace(/&/g, "_")
                    row.innerHTML = `
                        <td>${triggeredTime}</td>
                        <td><a href="https://www.tradingview.com/chart/?symbol=${urlSymbol}" target="_blank" style="color: #fff; text-decoration: underline;">${alert.symbol}</a></td>
                        <td class="trigger-type" style="color: ${typeColor};">${triggerType}</td>
                        <td>${setupTf}</td>
                        <td>${currentPrice}</td>
                        <td>${alert.details || 'No details provided.'}</td>
                    `;
                });

                this.statusElement.textContent = `Alerts feed active: ${data.length} total active alerts. Data refreshed.`;
            }

            /**
             * Starts the periodic data refresh process.
             */
            startAutoRefresh() {
                // Poll every 5 seconds for updated alerts (triggers are time-sensitive)
                setInterval(() => this.fetchData(false), 5000);
            }

            /**
             * Shows the loading indicator briefly.
             */
            showLoading() {
                this.loadingIndicator.style.display = 'inline-block';
                this.loadingIndicator.textContent = 'Fetching...';
            }

            /**
             * Hides the loading indicator.
             */
            hideLoading() {
                // Keep the loader visible for at least 0.5 second for feedback
                setTimeout(() => {
                    this.loadingIndicator.style.display = 'none';
                }, 500);
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new MultiStrategyDashboard();
        });
    </script>
</body>
</html>